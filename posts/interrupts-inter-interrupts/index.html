<!DOCTYPE html>
<html lang="en"><head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <style>
        :root {
            --accent-color: #65dbf0;
            --font-size: 1.3rem;
        }
    </style>

    
    
    
    
    
    

    
    <title>GBA Interrupts, and Exceptions</title>
    <meta name="description" content="If like me you are jumping to emulating the GBA after the DMG/GBC, you may be in a world of hurt when it comes to interrupts, exceptions and other advanced (ha) …">
    <meta name="keywords" content='emulation, gba'>

    <meta property="og:url" content="https://example.org/posts/interrupts-inter-interrupts/">
    <meta property="og:type" content="website">
    <meta property="og:title" content="GBA Interrupts, and Exceptions">
    <meta property="og:description" content="If like me you are jumping to emulating the GBA after the DMG/GBC, you may be in a world of hurt when it comes to interrupts, exceptions and other advanced (ha) …">
    <meta property="og:image" content="https://example.org/upload.wikimedia.org/wikipedia/commons/0/0b/Nintendo-Game-Boy-Advance-Purple-FL.png">
    <meta property="og:image:secure_url" content="https://example.org/upload.wikimedia.org/wikipedia/commons/0/0b/Nintendo-Game-Boy-Advance-Purple-FL.png">

    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="GBA Interrupts, and Exceptions">
    <meta name="twitter:description" content="If like me you are jumping to emulating the GBA after the DMG/GBC, you may be in a world of hurt when it comes to interrupts, exceptions and other advanced (ha) …">
    <meta property="twitter:domain" content="https://example.org/posts/interrupts-inter-interrupts/">
    <meta property="twitter:url" content="https://example.org/posts/interrupts-inter-interrupts/">
    <meta name="twitter:image" content="https://example.org/upload.wikimedia.org/wikipedia/commons/0/0b/Nintendo-Game-Boy-Advance-Purple-FL.png">

    
    <link rel="canonical" href="https://example.org/posts/interrupts-inter-interrupts/">

    
    <link rel="stylesheet" type="text/css" href="/css/normalize.min.css" media="print">

    
    <link rel="stylesheet" type="text/css" href="/css/main.min.css">

    
    <link id="dark-theme" rel="stylesheet" href="/css/dark.min.css">

    
    <script src="/js/bundle.min.fdbfba1e074acb7e4abbf4c94eb19abb7702489c9689a27ee5e24a2bd481e4b7.js" integrity="sha256-/b&#43;6HgdKy35Ku/TJTrGau3cCSJyWiaJ&#43;5eJKK9SB5Lc="></script>

    
    
</head>
<body>
        <script>
            
            setThemeByUserPref();
        </script><header class="header">
    <nav class="header-nav">

        
        <div class="avatar">
            <a href="https://example.org/">
                <img src='https://avatars.githubusercontent.com/u/22086435' alt="avatar">
            </a>
        </div>
        

        <div class="nav-title">
            <a class="nav-brand" href="https://example.org/">Aaron Balke</a>
        </div>

        <div class="nav-links">
            
            <div class="nav-link">
                <a href="https://github.com/aabalke" aria-label="a_github" ><span data-feather='github'></span>  </a>
            </div>
            
            <div class="nav-link">
                <a href="https://www.youtube.com/@whatnotdev" aria-label="b_youtube" ><span data-feather='youtube'></span>  </a>
            </div>
            
            <div class="nav-link">
                <a href="mailto:aabalke33@gmail.com" aria-label="c_mail" ><span data-feather='mail'></span>  </a>
            </div>
            

            <span class="nav-icons-divider"></span>
            <div class="nav-link dark-theme-toggle">
                <span class="sr-only dark-theme-toggle-screen-reader-target">theme</span>
                <a aria-hidden="true" role="switch">
                    <span class="theme-toggle-icon" data-feather="moon"></span>
                </a>
            </div>

            <div class="nav-link" id="hamburger-menu-toggle">
                <span class="sr-only hamburger-menu-toggle-screen-reader-target">menu</span>
                <a aria-checked="false" aria-labelledby="hamburger-menu-toggle" id="hamburger-menu-toggle-target" role="switch">
                    <span data-feather="menu"></span>
                </a>
            </div>

            
            <ul class="nav-hamburger-list visibility-hidden">
                
                <li class="nav-item">
                    <a href="https://github.com/aabalke" ><span data-feather='github'></span>  </a>
                </li>
                
                <li class="nav-item">
                    <a href="https://www.youtube.com/@whatnotdev" ><span data-feather='youtube'></span>  </a>
                </li>
                
                <li class="nav-item">
                    <a href="mailto:aabalke33@gmail.com" ><span data-feather='mail'></span>  </a>
                </li>
                
                <li class="nav-item dark-theme-toggle">
                    <span class="sr-only dark-theme-toggle-screen-reader-target">theme</span>
                    <a role="switch">
                        <span class="theme-toggle-icon" data-feather="moon"></span>
                    </a>
                </li>
            </ul>

        </div>
    </nav>
</header>
<main id="content">
    <div class="post container">
    <div class="post-header-section">
        <h1>GBA Interrupts, and Exceptions</h1>

        

        
	
	
	
	
        

	

	

	
          <small role="doc-subtitle"></small>
	

	
          <p class="post-date">
              

              July 1, 2025

              
          </p>
	

        <ul class="post-tags">
          
           
             <li class="post-tag"><a href="https://example.org/tags/emulation">emulation</a></li>
           
         
           
             <li class="post-tag"><a href="https://example.org/tags/gba">gba</a></li>
           
         
        </ul>
    </div>

    <div class="post-content">
        <p>If like me you are jumping to emulating the GBA after the DMG/GBC, you may be in
a world of hurt when it comes to interrupts, exceptions and other advanced (ha)
CPU behaviors. For starters lets outline some emulator implimentation considerations.
First, cycles matter significantly less on the GBA. This is because with the 2-4x faster
cpu, and opcode pretching - having expectations on specific opocdes completing at
certain times becomes impossible. Second, you will want to start with a bios file.
Do not make my mistake and try implimenting a HLE Bios from the start, it caused
me a world of heart and most of my problems (Huffman Encoding is black magic).</p>
<p>Before continuing, if you are interested in a mostly functional gba emulator,
please check out my Guac Emulator, written in Golang.</p>
<h1 id="big-picture">Big Picture</h1>
<p>As an emulator developer your goal with exceptions is to make them occur at the
right time, and once they are finished, return the state of the registers to how
they were before the interrupt.</p>
<p>Now for the astrisks. Not ALL registers, just r0 - r3, r12 and r14 (LR).</p>
<h1 id="which-exceptions-are-nessessary">Which Exceptions are nessessary</h1>
<p>If you read GBATEK or any other ARM7 Reference there are 8 types of exceptions
supported by the hardware. Most of these will not matter for GBA Emulation.</p>
<h2 id="normal-interrupts-irq">Normal Interrupts (IRQ)</h2>
<p>These should be familiar in theory to interrupts on the DMG/GBC, just bigger and
better.</p>
<h2 id="software-interrupts-swi">Software Interrupts (SWI)</h2>
<p>These are special interrupts to the bios file to cause certain functions to take
place. The simplest would be DIV, a call to a function to divide, but there are
many different function defined.</p>
<h2 id="fast-interrupts-fiq">Fast Interrupts (FIQ)</h2>
<p>The GBA does not support Fast Interrupts; however, many GBA Test Suites for GBA
Emulator development use these extra registers to store values. You will need to
impliment FIQ Registers to not be flying blind - however, Exception handling is
not required.</p>
<h2 id="not-required">Not required</h2>
<h3 id="undefined">Undefined</h3>
<p>For when a program hits an unknown instruction. MOST official GBA games will not
need this functionality.</p>
<h3 id="abort">Abort</h3>
<p>Almost exclusively used in Virtual Memory systems (not GBA).</p>
<h3 id="26-bit-exceeded">26 Bit Exceeded</h3>
<p>Used in 26 Bit Backwards compadible systems (not GBA).</p>
<h3 id="reset">Reset</h3>
<p>I geniunely have no idea how this is different from the SWI Reset.</p>
<h1 id="where-do-problems-occur">Where do problems occur?</h1>
<h2 id="nested-interrupts">Nested Interrupts</h2>
<h2 id="prefetching-opcodes--pipelining">Prefetching Opcodes / Pipelining</h2>
<h1 id="normal-interrupts-irqs">Normal Interrupts (IRQs)</h1>
<h2 id="entry">Entry</h2>
<p>An IRQ exception is entered when the Interrupt Master Enable Register (IME) is enabled,
CPSR FLAG I (Disable Interrupts) is off, and a matching flag in Interrupt Enable
Register (IE) and Interrupt Request Register (IF) is on. This is dense so lets
check some code.</p>
<pre tabindex="0"><code>// IF and IE are 16 bit registers that, when have matching bits mean a valid
// interrupt has been called. The simplest method for checking for a match is
// to use bitwise AND, and checking if none are on.
if (IF &amp; IE != 0) {
   
    // even if ime or cpsr flag I is on, the gba should be unhalted
    // this is important for the SWI IntraWait function, to reenable the gba
    halted = false

    if (IME &amp;&amp; !CPSR_FLAG_I) {
        Exception(MODE_IRQ)
    }
}
</code></pre><p>When should this be called? After every instruction or halt cycle, especially
since most emulators will not be cycle accurate. This will ensure no interrupts
are skipped.</p>
<h2 id="exit">Exit</h2>
<p>The return method for IRQs is:
SUBS PC,R14,4</p>
<p>When the return instruction is called:</p>
<h1 id="software-interrupts">Software Interrupts</h1>
<p>The return method for SWIs is:
MOVS PC,R14</p>
<p>When the return instruction is called:</p>
<p>PC becomes R14 (This is the R14/LR value from the supervisor bank NOT user / system</p>
<p>CPSR becomes SPSR (This is the supervisor bank version)</p>
<p>Banked Registers for LR and SP Registers should be swapped, setting SP, and LR
to the values inside the mode</p>
<pre tabindex="0"><code>
func MOV() {
    ...other logic...
    // destination is PC, RM is LR
    rd = rm

    if (rd == PC &amp;&amp; rm == LR &amp;&amp; setFlag) {
        Exit(MODE_SWI)
        return
    }

    ...set Alu Flags otherwise...
}

func Exit(mode int) {

    // PC is updated in the MOV instruction, this occurs afterwards

    // since system and user use same mode you will have to save mode =&gt; bank
    modeBank = bank[mode]

    CPSR = SPSRBank[modeBank]

    // this will be the mode before the exception
    // since it was Stored in SPSR[mode]
    currMode = CPSR &amp; 0b11111
    currBank = bank[currMode]

    // switch registers from exception banks to original banks prior to exception
    LRBank[modeBank] = LR
    SPBank[modeBank] = SP
    LR = LRBank[currBank]
    SP = SPBank[currBank]
}
</code></pre><h1 id="fast-interrupts-fiq-1">Fast Interrupts (FIQ)</h1>
<p>Since FIQs are not supported by the GBA, any use of this mode and these registers
has to be completed through MRS/MSR calls, &ldquo;shoving&rdquo; values into the Registers.</p>

        
    </div>

    <div class="prev-next">
        
    </div>

    
    
        <svg id="btt-button" class="arrow-logo" xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 384 512" onclick="scrollToTop()" title="Go to top">
    
    <path d="M177 159.7l136 136c9.4 9.4 9.4 24.6 0 33.9l-22.6 22.6c-9.4 9.4-24.6 9.4-33.9 0L160 255.9l-96.4 96.4c-9.4 9.4-24.6 9.4-33.9 0L7 329.7c-9.4-9.4-9.4-24.6 0-33.9l136-136c9.4-9.5 24.6-9.5 34-.1z"/>
</svg>
<script>
    let backToTopButton = document.getElementById("btt-button");

    window.onscroll = function() {
        scrollFunction()
    };

    function scrollFunction() {
        if (document.body.scrollTop > 20 || document.documentElement.scrollTop > 20) {
            backToTopButton.style.display = "block";
        } else {
            backToTopButton.style.display = "none";
        }
    }

    function scrollToTop() {
        window.scrollTo(0, 0);
    }
</script>

    
    
</div>



    

        </main><footer class="footer">
    
    

    

    

    

    <span>
    </span>
</footer>
</body>
</html>
